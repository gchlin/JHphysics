<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <style>
    :root {
      --primary: #234c7f;
      --primary-dark: #19263a;
      --primary-soft: #e7f0fb;

      --phy-color: #3498db;
      --chem-color: #27ae60;
      --bio-color: #e67e22;

      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
      --text-color: #333;
      --gray-light: #ecf0f1;
      --gray-dark: #7f8c8d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* --- Header: title + class buttons --- */
    header {
      background: #fff;
      padding: 10px 24px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-bottom: 3px solid var(--primary-soft);
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #2c3e50;
      white-space: nowrap;
    }

    .class-nav {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .class-btn {
      padding: 7px 22px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: var(--gray-light);
      cursor: pointer;
      font-weight: 600;
      color: var(--gray-dark);
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .class-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* --- Subject tabs --- */
    .subject-tabs {
      background: #fff;
      padding: 8px 24px 6px;
      border-bottom: 1px solid #e4e8ee;
      display: flex;
      gap: 16px;
    }

    .subject-tab {
      border: none;
      background: transparent;
      padding: 8px 4px;
      font-size: 0.95rem;
      cursor: pointer;
      color: var(--gray-dark);
      border-bottom: 3px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s, border-color 0.2s;
    }

    .subject-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }

    /* --- Main two-column layout --- */
    .main-layout {
      display: flex;
      flex: 1;
      padding: 24px;
      gap: 20px;
    }

    .left-panel {
      flex: 0 0 55%;
      max-width: 55%;
      display: flex;
      align-items: stretch;
    }

    .right-panel {
      flex: 0 0 45%;
      max-width: 45%;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* Countdown card */
    .timer-card {
      background: #fff;
      border-radius: 18px;
      padding: 28px 30px 26px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .timer-header {
      font-size: 1.1rem;
      color: var(--gray-dark);
      margin-bottom: 14px;
      letter-spacing: 1px;
    }

    .timer-main {
      font-size: 5rem;      /* 大字，維持你示意圖感覺 */
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      margin: 6px 0 4px;
      color: var(--phy-color);   /* 會用程式改成科目顏色 */
    }

    .timer-unit {
      font-size: 1.4rem;
      margin-left: 6px;
    }

    .timer-sub {
      font-size: 1.4rem;
      color: var(--gray-dark);
      margin-top: 10px;
    }

    .empty-state {
      color: #bdc3c7;
      font-style: italic;
      margin-top: 10px;
    }

    /* Calendar card */
    .calendar-card {
      background: #fff;
      padding: 18px 20px 18px;
      border-radius: 18px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .calendar-title {
      text-align: center;
      margin: 0 0 10px;
      color:#44566b;
      font-weight: 600;
      font-size: 1rem;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .month-btn {
      border: 1px solid #e4e8ee;
      background: #fff;
      color: #44566b;
      border-radius: 8px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, border-color 0.2s;
    }

    .month-btn:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
    }

    .cal-header-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-weight: bold;
      color: var(--gray-dark);
      margin-bottom: 6px;
      font-size: 0.85rem;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .cal-day {
      aspect-ratio: 1;
      border: 1px solid #eee;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #fff;
      font-size: 0.85rem;
    }

    .cal-day.today {
      border: 2px solid #f1c40f;
      background: #fffcf0;
    }
    
    .cal-day.past {
      background: #f9f9f9;
      opacity: 0.6;
    }

    .date-num {
      font-size: 0.75rem;
      color: #aaa;
      position: absolute;
      top: 4px;
      left: 5px;
    }

    .badge {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
    }

    .badge-x {
      color: #e74c3c;
      font-size: 1.3rem;
      font-weight: bold;
    }

    /* Key date cards (right panel, compressed height) */
    .key-dates {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .key-card {
      background: #1f2736;
      border-radius: 14px;
      padding: 10px 12px 11px;
      color: #ecf0f1;
      border: 1px solid rgba(255,255,255,0.12);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.9rem;
    }

    .key-title {
      font-size: 0.9rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .key-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #f1c40f;
    }

    .key-card.mock .key-dot {
      background: #e67e22;
    }

    .key-card.exam .key-dot {
      background: #2ecc71;
    }

    .key-date {
      font-size: 0.88rem;
    }

    .key-tag {
      font-size: 0.8rem;
      opacity: 0.85;
      margin-top: 1px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.4);
      font-size: 0.75rem;
    }

    footer {
      padding: 8px 20px 14px;
      text-align: center;
      color: #999;
      font-size: 0.8rem;
    }

    /* Responsive for small screens */
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .left-panel,
      .right-panel {
        flex: 0 0 100%;
        max-width: 100%;
      }
    }

    @media (max-width: 600px) {
      header {
        padding: 10px 16px;
      }
      .subject-tabs {
        padding: 8px 16px 6px;
      }
      .main-layout {
        padding: 18px 12px;
      }
      .timer-main {
        font-size: 3.5rem;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <!-- Header: title + class buttons -->
  <header>
    <div class="header-bar">
      <h1 id="pageTitle"></h1>
      <div class="class-nav"></div>
    </div>
  </header>

  <!-- Subject tabs -->
  <div class="subject-tabs"></div>

  <!-- Main layout -->
  <main class="main-layout">
    <!-- Left: countdown card -->
    <section class="left-panel">
      <div class="timer-card" id="timerCard">
        <div class="timer-header" id="timerTitle"></div>
        <div id="timerContent">
          <div class="timer-main">
            <span id="minDisplay">0</span><span class="timer-unit" id="timerUnit"></span>
          </div>
          <div class="timer-sub"><span id="periodDisplay">0</span> <span id="periodUnit"></span></div>
        </div>
        <div id="emptyMessage" class="empty-state" style="display:none;"></div>
      </div>
    </section>

    <!-- Right: calendar + key dates -->
    <section class="right-panel">
      <div class="calendar-card">
        <div class="calendar-nav">
          <button class="month-btn" id="prevMonthBtn" type="button">‹</button>
          <h3 class="calendar-title" id="calendarTitle"></h3>
          <button class="month-btn" id="nextMonthBtn" type="button">›</button>
        </div>
        <div class="cal-header-row" id="calendarHeaderRow"></div>
        <div class="cal-grid" id="calendarGrid"></div>
      </div>

      <div class="key-dates" id="keyDates"></div>
    </section>
  </main>

  <footer id="pageFooter"></footer>
</div>

<script>
  const dataUrl = './data/exam-counter.json';
  let appData = null;
  let specialDateMap = null;
  let currClass = null;
  let currSubject = null;
  let timerInterval = null;
  let viewYear = null;
  let viewMonthIndex = null;
  let isAutoMonth = true;

  const fallbackScopeMap = {
    high1: ['105', '107', '108', '109'],
    ib: ['115'],
    el: ['309', '311']
  };

  function buildSpecialDateMap(dates) {
    const map = {};
    dates.forEach(entry => {
      map[entry.day] = entry;
    });
    return map;
  }

  function getMonthRange() {
    const calendar = appData.calendar || {};
    if (!calendar.monthRange) return { start: 0, end: 11 };
    const start = Math.max(1, Math.min(12, calendar.monthRange.start));
    const end = Math.max(1, Math.min(12, calendar.monthRange.end));
    return {
      start: Math.min(start, end) - 1,
      end: Math.max(start, end) - 1
    };
  }

  function clampMonthToRange(year, monthIndex) {
    const range = getMonthRange();
    if (monthIndex < range.start) return { year, monthIndex: range.start };
    if (monthIndex > range.end) return { year, monthIndex: range.end };
    return { year, monthIndex };
  }

  function eventAppliesToClass(event, classId) {
    const scope = event.scope || 'all';
    if (scope === 'all') return true;
    if (scope === 'custom') {
      return Array.isArray(event.includeClasses) && event.includeClasses.includes(classId);
    }
    const scopeMap = appData.scopeClassMap || fallbackScopeMap;
    const classes = scopeMap[scope];
    if (!classes) return true;
    return classes.includes(classId);
  }

  function buildSpecialDateMapForMonth(year, monthIndex) {
    const calendar = appData.calendar || {};
    const map = {};

    if (Array.isArray(calendar.events) && calendar.events.length > 0) {
      calendar.events.forEach(event => {
        if (!event.date) return;
        const parts = event.date.split('-').map(Number);
        if (parts.length !== 3) return;
        const [evtYear, evtMonth, evtDay] = parts;
        if (evtYear !== year || evtMonth !== monthIndex + 1) return;
        if (!eventAppliesToClass(event, currClass)) return;
        map[evtDay] = event;
      });
      return map;
    }

    if (Array.isArray(calendar.specialDates)) {
      if (year === appData.meta.year && monthIndex === appData.meta.monthIndex) {
        return buildSpecialDateMap(calendar.specialDates);
      }
    }

    return map;
  }

  function applyStaticText() {
    document.title = appData.ui.title;
    document.getElementById('pageTitle').innerText = appData.ui.title;
    document.getElementById('timerUnit').innerText = appData.ui.timerUnit;
    document.getElementById('periodUnit').innerText = appData.ui.periodUnit;
    document.getElementById('emptyMessage').innerText = appData.ui.emptyMessage;
    document.getElementById('pageFooter').innerText = appData.ui.footer;

    const headerRow = document.getElementById('calendarHeaderRow');
    headerRow.innerHTML = '';
    appData.ui.weekdays.forEach(label => {
      const cell = document.createElement('div');
      cell.innerText = label;
      headerRow.appendChild(cell);
    });

    const keyDates = document.getElementById('keyDates');
    keyDates.innerHTML = '';
    appData.ui.keyCards.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.className = `key-card ${card.type}`;
      cardEl.innerHTML = `
        <div class="key-title">
          <span class="key-dot"></span>
          ${card.title}
        </div>
        <div class="key-date">${card.dateText}</div>
        <div class="key-tag">
          ${card.tagText}
          <span class="pill">${card.pillText}</span>
        </div>
      `;
      keyDates.appendChild(cardEl);
    });
  }

  function renderClassButtons() {
    const nav = document.querySelector('.class-nav');
    nav.innerHTML = '';
    appData.classes.forEach(cls => {
      const btn = document.createElement('button');
      btn.className = 'class-btn';
      btn.type = 'button';
      btn.dataset.classId = cls.id;
      btn.innerText = cls.label;
      btn.addEventListener('click', () => setClass(cls.id));
      nav.appendChild(btn);
    });
  }

  function renderSubjectTabs() {
    const tabs = document.querySelector('.subject-tabs');
    tabs.innerHTML = '';
    appData.subjectOrder.forEach(subjectKey => {
      const subject = appData.subjects[subjectKey];
      const btn = document.createElement('button');
      btn.className = 'subject-tab';
      btn.type = 'button';
      btn.dataset.subject = subjectKey;
      btn.innerText = subject.labelFull;
      btn.addEventListener('click', () => setSubject(subjectKey));
      tabs.appendChild(btn);
    });
  }

  function updateActiveButtons() {
    document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
    const activeClass = document.querySelector(`.class-btn[data-class-id="${currClass}"]`);
    if (activeClass) activeClass.classList.add('active');

    document.querySelectorAll('.subject-tab').forEach(b => b.classList.remove('active'));
    const activeSubject = document.querySelector(`.subject-tab[data-subject="${currSubject}"]`);
    if (activeSubject) activeSubject.classList.add('active');
  }

  // ---- UI switching ----
  function setClass(cls) {
    currClass = cls;
    updateActiveButtons();
    updateUI();
  }

  function setSubject(subj) {
    currSubject = subj;
    updateActiveButtons();
    updateUI();
  }

  function updateUI() {
    specialDateMap = buildSpecialDateMapForMonth(viewYear, viewMonthIndex);
    renderCalendar();
    updateTimer();

    const subject = appData.subjects[currSubject];
    document.querySelector('.timer-main').style.color = subject.color;
    document.getElementById('timerTitle').innerText = `${appData.ui.timerPrefix}${subject.labelShort}${appData.ui.timerSuffix}`;
    document.getElementById('calendarTitle').innerText = appData.ui.calendarTitleTemplate
      .replace('{subject}', subject.labelFull)
      .replace('{year}', viewYear)
      .replace('{month}', viewMonthIndex + 1);
  }

  // ---- Calendar ----
  function getDailyLessons(dayOfMonth) {
    const date = new Date(viewYear, viewMonthIndex, dayOfMonth);
    const dayOfWeek = date.getDay(); // 0-6

    if (specialDateMap[dayOfMonth]) return 'X';
    if (dayOfWeek === 0 || dayOfWeek === 6) return '';

    const sched = appData.schedule[currClass][currSubject];
    if (!sched) return 0;

    const daySched = sched.find(s => s.d === dayOfWeek);
    return daySched ? daySched.p.length : 0;
  }

  function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const firstDay = new Date(viewYear, viewMonthIndex, 1).getDay();
    for(let i=0; i<firstDay; i++) {
      grid.innerHTML += `<div></div>`;
    }

    const today = new Date();
    const isTargetMonth = today.getFullYear() === viewYear && today.getMonth() === viewMonthIndex;
    const currentDay = today.getDate();

    const daysInMonth = new Date(viewYear, viewMonthIndex + 1, 0).getDate();
    const isExamMonth = viewYear === appData.meta.year && viewMonthIndex === appData.meta.monthIndex;

    for(let d=1; d<=daysInMonth; d++) {
      const lessons = getDailyLessons(d);
      const el = document.createElement('div');
      el.className = 'cal-day';
      
      if (isTargetMonth && d === currentDay) el.classList.add('today');
      if (isTargetMonth && d < currentDay) el.classList.add('past');
      if (isExamMonth && d >= appData.meta.examStartDay) el.classList.add('past');  // 段考期間不再上課

      let content = `<span class="date-num">${d}</span>`;
      
      if (lessons === 'X') {
        content += `<div class="badge-x">${appData.ui.badgeX}</div>`;
      } else if (lessons > 0) {
        const color = appData.subjects[currSubject].color;
        content += `<div class="badge" style="background:${color}">${lessons}</div>`;
      }

      el.innerHTML = content;
      grid.appendChild(el);
    }
  }

  // ---- Countdown ----
  function calculateTime() {
    const now = new Date();

    const schedList = appData.schedule[currClass][currSubject];
    if (!schedList || schedList.length === 0) return null;

    let totalMins = 0;
    let totalPeriods = 0;

    for(let d=1; d<=appData.meta.countdownLastDay; d++) {
      if (specialDateMap[d]) continue;
      
      const dateCheck = new Date(appData.meta.year, appData.meta.monthIndex, d);
      const dw = dateCheck.getDay();
      if (dw === 0 || dw === 6) continue;

      const daySched = schedList.find(s => s.d === dw);
      if (!daySched) continue;

      daySched.p.forEach(pIdx => {
        const pTime = appData.periods[pIdx];
        const startParts = pTime.s.split(':').map(Number);
        const endParts = pTime.e.split(':').map(Number);

        const startT = new Date(appData.meta.year, appData.meta.monthIndex, d, startParts[0], startParts[1]);
        const endT = new Date(appData.meta.year, appData.meta.monthIndex, d, endParts[0], endParts[1]);

        if (now < startT) {
          totalMins += 50;
          totalPeriods += 1;
        } else if (now >= startT && now < endT) {
          const rem = (endT - now) / 60000;
          totalMins += rem;
          totalPeriods += (rem / 50);
        }
      });
    }
    return { 
      m: Math.floor(totalMins), 
      p: Math.round(totalPeriods)  // 取整數顯示
    };
  }

  function updateTimer() {
    const res = calculateTime();
    
    const timerContent = document.getElementById('timerContent');
    const emptyMsg = document.getElementById('emptyMessage');

    if (res === null) {
      timerContent.style.display = 'none';
      emptyMsg.style.display = 'block';
    } else {
      timerContent.style.display = 'block';
      emptyMsg.style.display = 'none';
      
      document.getElementById('minDisplay').innerText = res.m.toLocaleString();
      document.getElementById('periodDisplay').innerText = res.p;
    }

    if (isAutoMonth) {
      const now = new Date();
      const clamped = clampMonthToRange(now.getFullYear(), now.getMonth());
      if (clamped.year !== viewYear || clamped.monthIndex !== viewMonthIndex) {
        viewYear = clamped.year;
        viewMonthIndex = clamped.monthIndex;
        updateUI();
      }
    }
  }

  // ---- Init ----
  function setViewMonth(year, monthIndex, isAutoUpdate = false) {
    const clamped = clampMonthToRange(year, monthIndex);
    viewYear = clamped.year;
    viewMonthIndex = clamped.monthIndex;
    if (!isAutoUpdate) isAutoMonth = false;
    updateUI();
  }

  function shiftMonth(delta) {
    const newDate = new Date(viewYear, viewMonthIndex + delta, 1);
    const clamped = clampMonthToRange(newDate.getFullYear(), newDate.getMonth());
    if (clamped.year === viewYear && clamped.monthIndex === viewMonthIndex) return;
    setViewMonth(clamped.year, clamped.monthIndex);
  }

  async function init() {
    const response = await fetch(dataUrl);
    appData = await response.json();
    currClass = appData.defaults.classId;
    currSubject = appData.defaults.subject;
    const now = new Date();
    const clamped = clampMonthToRange(now.getFullYear(), now.getMonth());
    viewYear = clamped.year;
    viewMonthIndex = clamped.monthIndex;
    renderClassButtons();
    renderSubjectTabs();
    applyStaticText();
    updateActiveButtons();
    document.getElementById('prevMonthBtn').addEventListener('click', () => shiftMonth(-1));
    document.getElementById('nextMonthBtn').addEventListener('click', () => shiftMonth(1));
    timerInterval = setInterval(updateTimer, 1000);
    updateUI();
  }

  init();
</script>
</body>
</html>


