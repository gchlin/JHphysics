<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>互動單擺 | Mechanics Demo</title>
  <style>
    :root { --bg:#0b0f16; --fg:#e6edf3; --muted:#9fb0c3; --accent:#5aa9e6; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
    header h1{font-size:20px;margin:0 0 4px}
    header p{margin:0;color:var(--muted)}
    .panel{display:grid;grid-template-columns:1fr 320px;gap:16px}
    canvas{width:100%;height:auto;background:radial-gradient(closest-side at 50% 0%, #0f1722, #0b0f16)}
    .controls{background:#0f1722;border:1px solid #182235;border-radius:16px;padding:12px}
    .row{display:grid;grid-template-columns:1fr auto;align-items:center;margin:8px 0}
    .row label{font-size:14px;color:var(--muted)}
    .row output{font-variant-numeric:tabular-nums;color:var(--fg);min-width:60px;text-align:right}
    .row input[type="range"]{width:100%}
    .btns{display:flex;gap:8px;margin-top:8px}
    button{border:none;border-radius:10px;padding:8px 12px;background:#152238;color:var(--fg);cursor:pointer}
    button.primary{background:var(--accent);color:#041018;font-weight:600}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .eq{font-family:"Times New Roman", Georgia, serif; font-size:14px; color:#cbd5e1}
    @media (max-width: 900px){ .panel{grid-template-columns:1fr} }
    pre#testlog{background:#0f1722;color:#9fb0c3;padding:10px;border-radius:10px;font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>簡易互動單擺（RK4 數值積分）</h1>
      <p>可調整：擺長 L、重力 g、初始角度 θ₀、阻尼 c。顯示：即時角度、角速度、相圖（θ, ω）。</p>
    </header>

    <div class="panel">
      <canvas id="view" width="900" height="520" aria-label="pendulum-canvas"></canvas>
      <section class="controls" aria-label="controls">
        <div class="row"><label for="L">擺長 L (m)</label><output id="oL">1.00</output></div>
        <input id="L" type="range" min="0.2" max="3" step="0.01" value="1" />

        <div class="row"><label for="g">重力 g (m/s²)</label><output id="og">9.80</output></div>
        <input id="g" type="range" min="0.5" max="20" step="0.1" value="9.8" />

        <div class="row"><label for="theta0">初始角度 θ₀ (°)</label><output id="otheta0">20</output></div>
        <input id="theta0" type="range" min="-80" max="80" step="1" value="20" />

        <div class="row"><label for="omega0">初始角速度 ω₀ (rad/s)</label><output id="oomega0">0.00</output></div>
        <input id="omega0" type="range" min="-8" max="8" step="0.01" value="0" />

        <div class="row"><label for="c">阻尼 c (kg·m²/s)</label><output id="oc">0.05</output></div>
        <input id="c" type="range" min="0" max="0.3" step="0.005" value="0.05" />

        <div class="btns">
          <button id="reset">重設</button>
          <button id="pause">暫停</button>
          <button id="resume" class="primary">繼續</button>
        </div>
        <hr />
        <div class="meta">
          <div>θ(t) = 角度 (rad)</div>
          <div>ω(t) = 角速度 (rad/s)</div>
          <div class="eq">方程：θ¨ + (c/I) θ˙ + (g/L) sin θ = 0（點為對時間導數）</div>
        </div>
      </section>
    </div>

    <details>
      <summary>自動化測試結果</summary>
      <pre id="testlog"></pre>
    </details>
  </div>

  <script>
  // --- 簡易單擺（含阻尼）RK4 積分 ---
  const canvas = document.getElementById('view');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const canvasLeft = 0, canvasTop = 0, midX = W*0.35, anchorY = 90;
  const phaseX = W*0.62, phaseY = 48, phaseW = W*0.33, phaseH = H-96;

  // 參數
  const sL = document.getElementById('L');
  const sg = document.getElementById('g');
  const stheta0 = document.getElementById('theta0');
  const somega0 = document.getElementById('omega0');
  const sc = document.getElementById('c');
  const oL = document.getElementById('oL');
  const og = document.getElementById('og');
  const otheta0 = document.getElementById('otheta0');
  const oomega0 = document.getElementById('oomega0');
  const oc = document.getElementById('oc');
  const btnReset = document.getElementById('reset');
  const btnPause = document.getElementById('pause');
  const btnResume = document.getElementById('resume');

  // 惯量 I（點質量 mL^2，取 m=1）
  let I = 1;
  let running = true;

  function stateFromUI(){
    const L = parseFloat(sL.value);
    const g = parseFloat(sg.value);
    const c = parseFloat(sc.value);
    oL.textContent = L.toFixed(2);
    og.textContent = g.toFixed(2);
    oc.textContent = c.toFixed(3);
    return {L,g,c};
  }

  function reset(){
    const {L,g,c} = stateFromUI();
    theta = stheta0.value * Math.PI/180;
    omega = parseFloat(somega0.value);
    otheta0.textContent = stheta0.value;
    oomega0.textContent = somega0.value;
    trail = [];
    lastT = performance.now();
  }

  sL.oninput = stateFromUI; sg.oninput = stateFromUI; sc.oninput = stateFromUI;
  stheta0.oninput = ()=>{ otheta0.textContent = stheta0.value; };
  somega0.oninput = ()=>{ oomega0.textContent = somega0.value; };
  btnReset.onclick = reset;
  btnPause.onclick = ()=> running=false;
  btnResume.onclick = ()=> { running=true; lastT = performance.now(); };

  // 狀態
  let theta = 20*Math.PI/180; // rad
  let omega = 0;              // rad/s
  let trail = [];             // 相圖軌跡
  let lastT = performance.now();

  // ODE：theta' = omega; omega' = - (c/I) * omega - (g/L) * sin(theta)
  function derivs(t, y, p){
    const [th, om] = y; const {L,g,c} = p;
    return [om, - (c/I)*om - (g/L)*Math.sin(th)];
  }

  // RK4 單步
  function rk4Step(t, y, h, p){
    const k1 = derivs(t, y, p);
    const k2 = derivs(t + h/2, [y[0]+h*k1[0]/2, y[1]+h*k1[1]/2], p);
    const k3 = derivs(t + h/2, [y[0]+h*k2[0]/2, y[1]+h*k2[1]/2], p);
    const k4 = derivs(t + h,   [y[0]+h*k3[0],   y[1]+h*k3[1]],   p);
    return [
      y[0] + h*(k1[0]+2*k2[0]+2*k3[0]+k4[0])/6,
      y[1] + h*(k1[1]+2*k2[1]+2*k3[1]+k4[1])/6
    ];
  }

  function drawPendulum(L, g){
    ctx.save();
    ctx.clearRect(0,0,W,H);

    // 左：單擺
    ctx.translate(midX, anchorY);
    ctx.strokeStyle = '#1f2a3a';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0,0); ctx.lineTo(0, H);
    ctx.stroke();

    // 支點
    ctx.fillStyle = '#5aa9e6';
    ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();

    // 擺線與球
    const px = L*120*Math.sin(theta);
    const py = L*120*Math.cos(theta);
    ctx.strokeStyle = '#2e4158';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(px, py); ctx.stroke();
    ctx.fillStyle = '#cbd5e1';
    ctx.beginPath(); ctx.arc(px, py, 14, 0, Math.PI*2); ctx.fill();

    // 右：相圖
    ctx.restore();
    ctx.save();
    ctx.translate(phaseX, phaseY);
    ctx.fillStyle = '#0f1722';
    ctx.strokeStyle = '#1e293b';
    ctx.fillRect(0,0,phaseW,phaseH);
    ctx.strokeRect(0,0,phaseW,phaseH);

    // 軸
    ctx.strokeStyle = '#223046';
    ctx.beginPath();
    const xZero = phaseW/2, yZero = phaseH/2;
    ctx.moveTo(xZero,0); ctx.lineTo(xZero,phaseH);
    ctx.moveTo(0,yZero); ctx.lineTo(phaseW,yZero);
    ctx.stroke();

    // 相圖軌跡
    ctx.strokeStyle = '#5aa9e6';
    ctx.beginPath();
    for(let i=1;i<trail.length;i++){
      const [th,om] = trail[i];
      const [x,y] = phaseToXY(th, om);
      if(i===1) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // 目前狀態點
    const [cx, cy] = phaseToXY(theta, omega);
    ctx.fillStyle = '#e6edf3';
    ctx.beginPath(); ctx.arc(cx, cy, 3.2, 0, Math.PI*2); ctx.fill();

    // 標籤
    ctx.fillStyle = '#9fb0c3';
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('θ (rad)', phaseW - 52, yZero - 6);
    ctx.rotate(-Math.PI/2);
    ctx.fillText('ω (rad/s)', -phaseH + 8, xZero + 14);
    ctx.restore();
  }

  function phaseToXY(th, om){
    // θ: [-π, π] → x: [0, phaseW]
    const x = (th + Math.PI) / (2*Math.PI) * phaseW;
    // ω: clamp to [-6,6]
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const omc = clamp(om, -6, 6);
    const y = (1 - (omc + 6)/12) * phaseH;
    return [x,y];
  }

  function step(dt){
    // 穩定時間步
    const fixed = 1/120; // s
    let acc = dt; let t = 0; const p = stateFromUI();
    while(acc > 0){
      const h = Math.min(fixed, acc);
      [theta, omega] = rk4Step(t, [theta,omega], h, p);
      t += h; acc -= h;
    }
    // 角度限制到 [-π, π]
    if(theta > Math.PI) theta -= 2*Math.PI;
    if(theta < -Math.PI) theta += 2*Math.PI;

    // 記錄相圖
    trail.push([theta, omega]);
    if(trail.length > 1200) trail.shift();

    drawPendulum(p.L, p.g);
  }

  function loop(now){
    const dt = (now - lastT)/1000; // s
    lastT = now;
    if(running) step(dt);
    requestAnimationFrame(loop);
  }

  reset();
  requestAnimationFrame(loop);

  // --- 測試 ---
  const log = document.getElementById('testlog');
  function test(name, fn){
    try{ fn(); log.textContent += `✔ ${name}\n`; }
    catch(e){ log.textContent += `✘ ${name}: ${e.message}\n`; }
  }

  test("derivs returns array", ()=>{
    const res = derivs(0,[0,0],{L:1,g:9.8,c:0});
    if(!Array.isArray(res)) throw new Error("not array");
  });

  test("rk4Step small angle approx", ()=>{
    const y0=[0.1,0]; const p={L:1,g:9.8,c:0};
    const y1=rk4Step(0,y0,0.01,p);
    if(Math.abs(y1[0]-0.1)<1e-6) throw new Error("no evolution");
  });

  test("reset initializes theta", ()=>{
    stheta0.value=45; reset();
    if(Math.abs(theta - Math.PI/4)>1e-6) throw new Error("theta not reset");
  });

  </script>
</body>
</html>
